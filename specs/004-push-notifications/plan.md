# Implementation Plan: Push Notifications

**Branch**: `004-push-notifications` | **Date**: 2026-02-13 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/004-push-notifications/spec.md`

## Summary

Add push notifications to the Quran School app for all roles (student, teacher, parent). Event-driven notifications (sticker awards, attendance, homework) use Supabase Database Webhooks → Edge Functions → Expo Push API. Scheduled notifications (homework reminders, teacher summaries) use pg_cron → Edge Functions. Client-side uses `expo-notifications` for token registration, foreground handling, and deep-link navigation. User preferences and quiet hours are managed via a new `notification_preferences` table.

## Technical Context

**Language/Version**: TypeScript 5.9 (strict mode), Deno (Edge Functions)
**Primary Dependencies**: expo-notifications, expo-device, expo-constants, @supabase/supabase-js 2, Expo Push API
**Storage**: Supabase PostgreSQL — 2 new tables (`push_tokens`, `notification_preferences`), 1 altered table (`schools` — timezone column)
**Testing**: Manual testing on physical devices (push notifications don't work in simulators/Expo Go); Edge Functions tested via curl
**Target Platform**: iOS 15+ / Android (Expo managed workflow, Development Build required for push)
**Project Type**: Mobile (Expo React Native) + Supabase Edge Functions (Deno)
**Performance Goals**: <10 second notification delivery latency from event to device
**Constraints**: Development Build required (no Expo Go), physical device required, Expo Push API rate limit 600/sec
**Scale/Scope**: ~100-500 users per school, 9 notification categories, 3 Edge Functions, 2 new DB tables, 1 new feature module

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Multi-Tenant by Default | PASS | `push_tokens` doesn't need `school_id` (scoped via user FK to profiles which has school_id). Notification delivery queries join through profiles → school for timezone. |
| II. Role-Based Access (4 Roles) | PASS | Notification categories are role-aware. RLS on `push_tokens` and `notification_preferences` scoped to own user. Edge Functions use service role key. |
| III. TypeScript-First, Strict Mode | PASS | All client code in strict TypeScript. Edge Functions in TypeScript (Deno). All entities have defined interfaces. |
| IV. Feature Colocation | PASS | New `src/features/notifications/` directory with hooks, services, types, components, config. No cross-feature imports. |
| V. Logical CSS Only (RTL/LTR) | PASS | Notification preferences UI uses logical properties. In-app banner uses logical layout. |
| VI. i18n Mandatory | PASS | All notification content localized (EN/AR). UI strings go through i18next. Notification body text uses recipient's `preferred_language`. |
| VII. Supabase-Native Patterns | PASS | Direct Supabase SDK in service files. RLS on all new tables. Migration via Supabase tooling. Edge Functions with `SET search_path = public` on helper functions. |
| VIII. Minimal Animation | PASS | In-app banner uses simple slide-in/out animation via reanimated. No heavy effects. |

**Post-Phase 1 re-check**: All gates still pass. Edge Functions are Deno TypeScript (not client TypeScript) but this is the standard Supabase pattern. No constitution violations.

## Project Structure

### Documentation (this feature)

```text
specs/004-push-notifications/
├── plan.md              # This file
├── research.md          # Technology research findings
├── data-model.md        # New tables and relationships
├── quickstart.md        # Testing guide
├── contracts/
│   └── edge-functions.md # Edge Function contracts
├── checklists/
│   └── requirements.md  # Spec quality checklist
└── tasks.md             # Task list (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
src/features/notifications/          # New feature module
├── hooks/
│   ├── useNotificationSetup.ts      # Token registration + permission flow
│   ├── useNotificationHandler.ts    # Foreground handling + tap navigation
│   └── useNotificationPreferences.ts # Preferences CRUD hooks
├── services/
│   └── notifications.service.ts     # Supabase calls for tokens & preferences
├── components/
│   ├── NotificationSoftAsk.tsx      # Soft-ask permission explanation screen
│   ├── NotificationPreferences.tsx  # Preferences toggles + quiet hours UI
│   └── InAppBanner.tsx              # Custom foreground notification banner
├── types/
│   └── notifications.types.ts       # TypeScript interfaces
├── config/
│   └── notification-categories.ts   # Category definitions per role
└── index.ts                         # Barrel export

supabase/
├── migrations/
│   └── 00004_push_notifications.sql # Tables, RLS, triggers, cron jobs
└── functions/                       # NEW directory
    ├── send-notification/
    │   └── index.ts                 # Event-driven notification delivery
    ├── homework-reminder/
    │   └── index.ts                 # Scheduled homework reminders
    └── teacher-daily-summary/
        └── index.ts                 # Scheduled teacher morning summary

# Modified existing files:
src/features/auth/services/auth.service.ts   # Add token cleanup on logout
src/features/auth/hooks/useLogout.ts         # Add token removal step
app/_layout.tsx                              # Add notification setup hook
app/(student)/(tabs)/_layout.tsx             # (or profile) link to prefs screen
app/(teacher)/(tabs)/_layout.tsx             # link to prefs screen
app/(parent)/(tabs)/_layout.tsx              # link to prefs screen
src/i18n/en.json                             # Notification strings (EN)
src/i18n/ar.json                             # Notification strings (AR)
```

**Structure Decision**: Follows the existing feature colocation pattern (`src/features/notifications/`). Edge Functions are new to the local codebase (previously deployed remotely only) — creating `supabase/functions/` directory for the first time. The 3 Edge Functions are separate deployable units per Supabase conventions.

## Complexity Tracking

> No constitution violations. No complexity justifications needed.

## Key Architecture Decisions

### Event-Driven vs. Client-Triggered Notifications

**Chosen**: Database Webhooks (server-side triggers)

**Why**: Ensures notifications fire regardless of which client triggers the change (teacher app, admin panel, direct SQL). More reliable than client-side Edge Function calls which depend on the client completing the request.

### Fire-and-Forget vs. Notification Queue Table

**Chosen**: Fire-and-forget (no persistent notification queue)

**Why**: Clarification phase decided against an in-app notification inbox. Edge Functions handle delivery directly — no intermediate `notifications` table needed. Failed deliveries are retried inline (up to 3 times). This keeps the data model simple.

### Column-per-Category vs. Row-per-Category Preferences

**Chosen**: Column-per-category (single row per user)

**Why**: Fixed set of 9 notification types. Single-row lookup is simpler and faster than joining multiple rows. Adding a new category later requires a migration (add column) but this is acceptable given the stable, small category set.

### Cron Frequency for Timezone-Aware Scheduling

**Chosen**: Run cron every 15 minutes, check school timezone in Edge Function

**Why**: Schools may be in different timezones. Running cron frequently and filtering by school timezone in the Edge Function ensures all schools get notifications at the right local time without needing per-school cron jobs.
